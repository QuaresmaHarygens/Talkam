from datetime import datetime, timedelta

from fastapi import APIRouter, Depends

from ..config import Settings
from ..schemas.report import MediaRef
from .deps import get_settings_dep

router = APIRouter(prefix="/media", tags=["media"])


@router.post("/upload")
async def request_upload(body: MediaRef, settings: Settings = Depends(get_settings_dep)) -> dict:
    expires = datetime.utcnow() + timedelta(minutes=15)
    return {
        "upload_url": f"{settings.s3_endpoint}/upload/{body.key}",
        "expires_in": 900,
        "media_key": body.key,
        "headers": {"x-amz-meta-checksum": body.checksum or ""},
        "expires_at": expires.isoformat() + "Z",
    }
